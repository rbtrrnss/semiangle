<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semiangle Calculator</title>
  <!--
  Original HTML Application (HTA) written by Armand Béché (~2008).
  Adapted to a web page by Alexander Zintler (2025).  
  Debye rings simulated with ReciPro https://github.com/seto77/ReciPro
  -->
  <style>
    /* make box-sizing consistent so widths include padding */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 0 1em;
    }
    label { font-weight: bold; display: block; margin-top: 1em; }
    /* make inputs fill their container but not exceed parent widths */
    input { width: 100%; padding: 0.4em; max-width: none; }
    .input-block {
      display: flex;
      gap: 1em;
      align-items: flex-end;
      margin-top: 1em;
      width: 100%;
      max-width: none; /* fill the same content width as the HT input */
    }
    .input-block label {
      flex: 1 1 0;
      margin: 0;
      font-weight: bold;
    }
    .output { margin-top: 1em; background: #f0f0f0; padding: 1em; border-radius: 6px; width: 100%; max-width: none; }
    button.ht-preset { margin: 0.5em 0.3em; padding: 6px 10px; font-size: 1.1em;}
    #button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 1.5em;
    }
    .targets { margin-top: 1em; max-width: 550px; }
    .targets table, th, td { border: 1px solid gray; }
    .targets table { width: 100%; border-collapse: collapse; table-layout: auto; }
    .targets td {
      font-weight: normal;
      padding: 0.1rem;
      text-align: center;
    }
    #button-container button {
      padding: 12px 20px;
      font-size: 1.2em;
    }
    /* Container for Debye rings image so overlays can be placed on top */
    .rings-container {
      position: relative;
      width: 100%;
      max-width: 546px;
      margin: 0.5em auto;
    }
    .rings-container img {
      width: 100%;
      height: auto;
      display: block;
    }
    .rings-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    /* triangle marker (hidden by default) */
    .ring-marker {
      position: absolute;
      top: 50%;
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 12px solid #0acab0; /* triangle pointing down */
      transform: translate(-50%, -10%);
      opacity: 0;
      pointer-events: none;
    }
    .ring-marker.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <h1>Semiangle Calculator</h1>

  <form onsubmit="calculate(); return false;">
    <label>High Tension [kV]:
      <input type="number" id="ht" value="300" enterkeyhint="next">
    </label>
    Presets:
    <button type="button" class="ht-preset" onclick="setHT(60)" tabindex="-1">60</button>
    <button type="button" class="ht-preset" onclick="setHT(80)" tabindex="-1">80</button>
    <button type="button" class="ht-preset" onclick="setHT(120)" tabindex="-1">120</button>
    <button type="button" class="ht-preset" onclick="setHT(200)" tabindex="-1">200</button>
    <button type="button" class="ht-preset" onclick="setHT(300)" tabindex="-1">300</button>
    <div class="input-block">
      <label>BF disk diameter [px]:
        <input type="number" id="bf_disk" value="210" enterkeyhint="next" step="any">
      </label>

      <label>
        <nobr>Au&nbsp;<select name="hkl" id="hkl">
          <option value="111">(111)</option>
          <option value="200">(200)</option>
          <option value="220">(220)</option>
          <option value="113">(113)</option>
          <option value="222" style="color:gray">(222)</option>
          <option value="400">(400)</option>
        </select>&nbsp;diameter [px]:</nobr>
        <input type="number" id="au_diameter" value="100" enterkeyhint="next" step="any">
      </label>
    </div>

    <div class="input-block">
      <label>Desired semiangle [mrad]:
        <input type="number" id="desired_angle" value="21" enterkeyhint="next" step="any">
      </label>

      <label>UI displayed semiangle [mrad]:
        <input type="number" id="ui_angle" value="20.7" enterkeyhint="send" step="any">
      </label>
    </div>

    <div id="button-container">
      <button type="submit">Calculate</button>
    </div>
  </form>

  <div class="output" id="output"></div>

  <div class="targets" id="targets">
    <details>
      <summary>aberration target parameters 300 kV + Au Debye rings</summary>
       <table>
        <tr>
          <th>C1</th>
          <th>A1</th>
          <th>B2</th>
          <th title="use A2 coarse, if HPx/HPy >30mA, reset A2">A2</th>
          <th>C3</th>
          <th style="background-color:lemonchiffon" title="30% steps, check low orders again">S3</th>
          <th style="background-color:lemonchiffon" title="before correcting: &#013;image mode, &#013;medium mag, &#013;mark beam position &#013;&#013;apply correction, &#013;recenter with DPH1">A3</th>
        </tr>
        <tr>
          <td>~0 nm</td>
          <td>&#60;5 nm</td>
          <td>&#60;20 nm</td>
          <td>&#60;50 nm</td>
          <td>~1 µm</td>
          <td style="background-color:lemonchiffon">&#60;500 nm</td>
          <td style="background-color:lemonchiffon">&#60;2 µm</td>
        </tr>
      </table><br>
      <div class="rings-container">
        <img src="./rings.png" alt="Debye rings of Au, simulated with ReciPro">
        <div class="rings-overlay" aria-hidden="true">
          <div id="ringMarker" class="ring-marker" aria-hidden="true"></div>
        </div>
      </div>
    </details>
  </div>


  <script>
    // IDs of input fields in order to tab through them in the correct order
    const inputIds = ["ht", "bf_disk", "au_diameter", "desired_angle", "ui_angle", "hkl"];

    inputIds.forEach((id, idx) => {
      const input = document.getElementById(id);
      input.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          if (idx < inputIds.length - 1) {
            document.getElementById(inputIds[idx + 1]).focus();
          } else {
            calculate();
          }
        }
      });
      
      // Highlight all text on focus
      input.addEventListener('focus', function(event) {
        event.target.select();
      });
      // Recalculate when the user changes input/select values
      input.addEventListener('input', function() { calculate(); });
      input.addEventListener('change', function() { calculate(); });
    });

    function setHT(val) {
      const htEl = document.getElementById("ht");
      htEl.value = val;
      // dispatch input/change so any listeners react, then recalculate
      htEl.dispatchEvent(new Event('input', { bubbles: true }));
      htEl.dispatchEvent(new Event('change', { bubbles: true }));
      calculate();
    }

    function calculate() {
      const ht_kv = parseFloat(document.getElementById("ht").value);
      const bf_disk = parseFloat(document.getElementById("bf_disk").value);
      const au_diameter = parseFloat(document.getElementById("au_diameter").value);
      const desired_angle = parseFloat(document.getElementById("desired_angle").value);
      const ui_angle = parseFloat(document.getElementById("ui_angle").value);

      if ([ht_kv, bf_disk, au_diameter, desired_angle, ui_angle].some(isNaN)) {
        document.getElementById("output").innerHTML = "Please enter valid numbers in all fields. Use . as decimal separator.";
        return;
      }

      // Constants (SI units)
      const h = 6.62607015e-34;   // Planck's constant [J·s]
      const c = 2.99792458e8;     // Speed of light [m/s]
      const m_e = 9.1093837e-31;  // Electron mass [kg]
      const e = 1.60217663e-19;   // Elementary charge [C]

      const V = ht_kv * 1e3;      // Accelerating voltage [V]

      // Relativistic electron wavelength [m]
      const lambda_m = h / Math.sqrt(2 * m_e * e * V * (1 + (e * V) / (2 * m_e * c * c)));
      // For display
      const lambda_nm = lambda_m * 1e9;

      // Au lattice distance table (nm)
      const d111_nm = 0.2354579; // nm
      const d200_nm = 0.2039125; // nm
      const d220_nm = 0.1441879; // nm
      const d113_nm = 0.1229639; // nm
      const d222_nm = 0.1177289; // nm
      const d400_nm = 0.1019563; // nm

      // Choose d-spacing based on selected HKL
      const hkl = document.getElementById("hkl").value;
      let d_nm;
      switch (hkl) {
        case "200": d_nm = d200_nm; break;
        case "220": d_nm = d220_nm; break;
        case "113": d_nm = d113_nm; break;
        case "222": d_nm = d222_nm; break;
        case "400": d_nm = d400_nm; break;
        case "111":
        default:
          d_nm = d111_nm; break;
      }

      const d_m = d_nm / 1e9; // m
      const G = 1 / d_nm; // 1/nm
      let au_semiangle = Math.asin(lambda_m / (2 * d_m)) * 1000; // mrad

      const scale = au_diameter / (2 * au_semiangle);
      const actual_semiangle = bf_disk / scale; // mrad

      const ui_toset = ui_angle / actual_semiangle * desired_angle;

      // this gives the probe size only limited by diffraction. Not a good estimate.
      // const expected_probesize = 0.61 * lambda_nm * 1000 / (desired_angle / 1000); // pm
      
      // empirical formula, manually adjusted to fit the estimated probe size of CEOS aberration corrector predictions
      // in the future, it would be nice to simulate probe sizes (e.g. abTEM) and make a more physical model
      const expected_probesize = 0.61 * lambda_nm * 1000 / (desired_angle / 1000) + desired_angle * (410/ht_kv) - 0.4 * (lambda_nm)**0.3 - 5000 / ht_kv; // pm
      // expected_probesize is in pm. Convert to nm then take reciprocal to get nm^-1.
      const visible_rings = expected_probesize > 0 ? 1000 / expected_probesize : 0; // nm^-1
      const pixel_resolution = 0.0281261; // nm^-1 per pixel
      const marker_position_px = 34 + visible_rings / pixel_resolution; // px, 34px is the offset for the (000) spot
      const marker_reference_extent_px = 512; // reciprocal image extent used for marker_position_px scaling

      // position and reveal the triangular marker
      const marker = document.getElementById('ringMarker');
      if (marker && visible_rings > 0) {
        const xPercent = Math.min(Math.max(marker_position_px / marker_reference_extent_px, 0), 1) * 100;
        marker.style.left = `${xPercent}%`;
        marker.classList.add('visible');
      } else if (marker) {
        marker.classList.remove('visible');
      }

      document.getElementById("output").innerHTML = `
        <strong>Actual semiangle:</strong> ${actual_semiangle.toFixed(1)} mrad<br>
        <strong>Set UI semiangle to:</strong> ${ui_toset.toFixed(1)} mrad<br>
        <strong>Estimated D<sub>50</sub> at ${desired_angle.toFixed(0)} mrad:</strong> ${expected_probesize.toFixed(0)} pm  
      `;
    }
  </script>

</body>
</html>

